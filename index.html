<!DOCTYPE html>
<html lang="en">

<head>
  <title>pgAdmin4 restricted k8s deployment</title>
</head>

<body>
  <h1>pgAdmin4 running on most restricted kubernetes environment</h1>
  <a href="https://github.com/KorenP1">GitHub</a>
  <p>
    May 14th 2025 <br><br>
    
    Running pgAdmin4 on certain kubernetes distributions that includes security policies like OpenShift 'restricted-v2' SCC or 'restricted' Pod Security Standard can be a real pain and difficult even if you are very experienced with kubernetes and security concepts of k8s. <br><br>
    
    Most people will find themselves either giving some privileges to their container or using some custom made container image or giving up.
    
    It is true that pgAdmin4 container is not well suited for DevOps security standards. <br><br>
    
    Lets get to the practical needs to run it. <br><br>
    
    First of all, the pgAdmin4 container runs as predefined user 'pgadmin' by default and I have commited to official pgAdmin github repo to change it to user 5050 instead in the dockerfile because if k8s securityContext runAsNonRoot=true is set, k8s wouldn't know what uid the user would run by its metadata. Implementation since pgAdmin v9.4.0 which doesn't exist the time im writing this but tag 'snapshot' can be used instead. <br><br><br><br><br>
    
    I will number the things we have to handle to run this container securely <br><br><br>
    1. Disable postfix service (If you don't disable it, the application will throw a warning but won't crash) <br><br>
    2. Writing pgadmin data to /var/lib/pgadmin (Not a must if running as user 5050 and readOnlyFileSystem=false is set, otherwise a must)
    3. writing logs to /var/log/pgadmin during runtime, we don't have permissions as random UID (Not a must if running as user 5050 and readOnlyFileSystem=false is set, otherwise a must) <br><br>
    4. writing files to /tmp (Important only if using securityContext readOnlyFileSystem=true, not a must in OpenShift restricted-v2 SCC / restricted PSS) <br><br>
    5. /pgadmin4/config_distro.py file is getting overriden during runtime, we don't have permissions if we are using random UID (Not a must if running as user 5050 and readOnlyFileSystem=false is set, otherwise a must) <br><br>
    6. Allow the usage of 'python3' CLI <br><br><br><br><br>
    
    Lets look at each of them <br><br><br>
    1. Probably the easiest, adding the next environment variable to your pod. PGADMIN_DISABLE_POSTFIX=true <br>
    <code>
      env:
      	- name: PGADMIN_DISABLE_POSTFIX
          value: "true"
    </code>
    <br><br>
    2. Adding a volume to /var/lib/pgadmin path, can be either PVC or emptyDir <br>
    <code>
      volumes:
      	- name: pgadmin-data
          emptyDir: {}
    </code>
    <code>
      volumeMounts:
      	- name: pgadmin-data
          mountPath: /var/lib/pgadmin
    </code>
    <br><br>
    3, 4. Adding an emptyDir volume to /var/log/pgadmin, /tmp paths. <br>
    <code>
      volumes:
      	- name: empty-dir
          emptyDir: {}
    </code>
    <code>
      volumeMounts:
      	- name: empty-dir
          mountPath: /var/log/pgadmin
          subPath: logs
        - name: empty-dir
          mountPath: /tmp
          subPath: /tmp
    </code>
    <br><br>
  </p>
</body>

</html>
